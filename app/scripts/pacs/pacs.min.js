window.baseUrl=getBaseUrl();window.patient_basic_info={};var PACS=PACS||{};var pacsApp=angular.module("pacsApp",["ngRoute","ngResource","ngSanitize","CommonServices","DictServices"]);var pacsImages=[["000","images/pacs/t0.fw.png"],["001","images/pacs/t1.fw.png"],["002","images/pacs/t2.fw.png"],["003","images/pacs/t3.fw.png"]];function convertQrResult(c){var b,a;result=[];for(b=0;b<c.length;b++){item=c[b];objItem={};for(a=0;a<item.length;a++){field=item[a];objItem[field[6]]=field[3]}result[b]=objItem}return result}function thumbImageIdx(a){return 0}function getStream(b,f){var a=this;b=window.baseUrl+b;var c=new XMLHttpRequest();c.open("GET",b,true);c.responseType="arraybuffer";var e=new Date().getTime(this);c.onload=function(l){if(this.status==200){var h=new Date().getTime();var k=h-e;var g=this.response.byteLength;f(this.response);var j=g*8/(k*1000)}else{d("get stream failed")}};c.onerror=function(g){d("Error loading");f(null)};c.onprogress=function(h){if(h.lengthComputable){var g=Math.floor(100*h.loaded/h.total)}};c.send(null)}pacsApp.controller("pacsCtrl",function(a,b,c,e){b.user=appCache.getObject("User");if(!b.user){}b.studyUid="1.2.410.200010.1095124.1103.704380.849064.11382513.849064";b.studyUid="1.2.410.200010.1112741.5585.705356.850045.11383076.850045";b.studyUid="1.2.410.200010.1012110.7710.703299.847980.11381931.847980";b.studyUid="1.2.840.113704.9.4021.1.0.20090207094634000";b.studyUid="1.2.410.200010.1081152.796.1531683.1682240.11797453.1682240";if(window.location.hostname=="120.25.124.115"){}b.title="影像查看";b.rightWrapper=document.getElementById("rightWrapper");b.leftWrapper=document.getElementById("leftWrapper");b.layout=12;b.maxLayoutRow=4;b.maxLayoutCol=4;b.tools=new PACS.Tool();b.luts=PACS.Luts;b.filters=PACS.Filters;b.seriesList=$("#seriesList");b.checkImageLoad=function(g,f,h,k){if(h.detail&&h.data){h.loadState=2;extendPacsImage(h);k(true);if(f==thumbImageIdx(g.images.length)){var j=document.getElementById("s-canvas-"+g.index);if(j){h.drawThumb(j)}}g.onImageloaded(f,h)}};b._loadImageDetail=function(k,j,n){var m=k.images[j];m.detail=null;m.loadState=1;var l="reqType=imageDetails&studyUid="+b.studyUid+"&sopUid="+m.SOPInstanceUID;var h=function(p){if(p&&p.rows){var o=listToObject(p,"rows").rows;if(o&&o.length){m.detail=o[0];b.checkImageLoad(k,j,m,n)}else{n(false)}}else{d("_loadImageDetail error");n(false)}};e.getAll("dcmgw",l,h,h);var f=function(o){if(o){m.data=o;b.checkImageLoad(k,j,m,n)}else{m.loadState=-1;d("_loadImageDetail error");n(false)}};var g="dcmgw?reqType=imageData&studyUid="+b.studyUid+"&sopUid="+m.SOPInstanceUID;getStream(g,f)};b.loadImageDetail=function(f){if(!f.images||!f.images.length){return}while(f.loadIdx<f.images.length){image=f.images[f.loadIdx];if(!image.loadState){break}f.loadIdx+=1}if(f.loadIdx>=f.images.length){return}b._loadImageDetail(f,f.loadIdx,function(h,g){b.loadImageDetail(f)});f.loadIdx++};b.loadImages=function(f){var g="reqType=image&studyUid="+b.studyUid+"&seriesNumber="+f.SeriesNumber;e.getAll("dcmgw",g,function(j){if(!j.result){return}var h=convertQrResult(j.result);h.sort(function(l,k){return parseInt(l.InstanceNumber)-parseInt(k.InstanceNumber)});f.images=h;if(h.length>0){}b.loadImageDetail(f)},function(){d("loadSeriesImages error")})};b.initSeries=function(){if(!b.series){return}var g;for(g=0;g<b.series.length;g++){var h=b.series[g];extendPacsSeries(h);h.index=g;h.imgCount=0;h.loadIdx=0;h.thumbUrl="images/pacs/default.jpg";b.loadImages(h)}for(g in b.vViews){if(g>=b.series.length){break}var f=b.vViews[g];f.setSeries(b.series[g])}};b.loadSeries=function(){var f="reqType=series&studyUid="+b.studyUid;e.getAll("dcmgw",f,function(h){if(!h.result){return}var g=convertQrResult(h.result);b.series=g;b.initSeries()},function(){d("loadSeries error")})};b.__apply=function(){if(!a.$$phase){}else{d("__apply busy with : "+a.$$phase)}};b.cancelDrawing=function(j){var k=b.vViews;var g=k.length;var f;for(var h=0;h<g;h++){f=k[h];if(j||f!=b.selView){f.cancelDrawing()}}};b.pvListeners={onSelected:function(f,h){if(!h){b.selView=null;selectLi(b.seriesList,null,"active");return}if(f.series){var g=f.series.index;setTimeout(function(){selectLi(b.seriesList,$("#s-li-"+g),"active")},0)}b.selView=f;b.cancelDrawing(false)},getSeries:function(f){if(undefined==f){return b.series}if(f>=0&&f<b.series){return b.series[f]}return null},getTools:function(){return b.tools},syncLinked:function(f,l){if(!b.tools.linked){return}d("$scope syncLinked");var k=b.vViews;var h=k.length;var g;for(var j=0;j<h;j++){g=k[j];if(g!=f){g.syncLinked(l)}}}};b.initCanvas=function(){var f=[];var h=b.pvListeners;for(var g=0;g<b.maxLayoutRow*b.maxLayoutCol;g++){f[g]=new PACS.View("pv-"+g,h)}b.pacsViews=f};b.initCanvas();b.initLayout=function(){var k=0;var u=[];var f,p,q,m;var l=b.wrapperW;var g=b.wrapperH;var n=b.layout;d("Layout all   w:"+l+" h:"+g);if(b.layout>100){var o=Math.floor(b.layout/100);var q,m;var t;for(i=0;i<b.pacsViews.length;i++){var s=b.pacsViews[i];t=false;if(i<o){switch(b.layout){case 301:switch(i){case 0:p=2;f=1;q=Math.floor((l-10*(p+1)-1)/p);m=Math.floor((g-10*(f+1))/f);break;case 1:case 2:default:p=2;f=2;q=Math.floor((l-10*(p+1)-1)/p);m=Math.floor((g-10*(f+1))/f);break}break;case 302:switch(i){case 2:p=1;f=2;q=Math.floor((l-10*(p+1)-1)/p);m=Math.floor((g-10*(f+1))/f);break;case 0:case 1:default:p=2;f=2;q=Math.floor((l-10*(p+1)-1)/p);m=Math.floor((g-10*(f+1))/f);break}break;case 303:switch(i){case 0:p=1;f=2;q=Math.floor((l-10*(p+1)-1)/p);m=Math.floor((g-10*(f+1))/f);break;case 1:case 2:default:p=2;f=2;q=Math.floor((l-10*(p+1)-1)/p);m=Math.floor((g-10*(f+1))/f);break}break;case 304:default:switch(i){case 1:p=2;f=1;q=Math.floor((l-10*(p+1)-1)/p);m=Math.floor((g-10*(f+1))/f);t=true;break;case 0:case 2:default:p=2;f=2;q=Math.floor((l-10*(p+1)-1)/p);m=Math.floor((g-10*(f+1))/f);break}break}d("Layout child:"+i+" w:"+q+" h:"+m);s.show(t);s.setSize(q,m);u[k]=s;k++}else{s.hide()}}}else{f=Math.floor(n/10);p=Math.floor(n%10);q=Math.floor((l-10*(p+1)-1)/p);m=Math.floor((g-10*(f+1))/f);d("Layout child w:"+q+" h:"+m);for(i=0;i<b.pacsViews.length;i++){var s=b.pacsViews[i];var x=i/p;var j=i%p;if(x<f&&j<p){s.show();s.setSize(q,m);u[k]=s;k++}else{s.hide()}}}b.vViews=u;if(u.length==1){u[0].setSelected(true)}else{if(!b.selView||!b.selView.shown){if(u.length>0){u[0].setSelected(true)}}}};b.initView=function(){var g=parseInt(document.body.clientWidth)-182;var f=document.body.clientHeight-42;d("initView w:"+g+" h:"+f);if(g<600){g=600}if(f<400){f=400}b.rightWrapper.style.width=g+"px";b.rightWrapper.style.height=f+"px";b.leftWrapper.style.height=f+"px";b.wrapperW=g;b.wrapperH=f;setTimeout(function(){b.initLayout()},10)};window.onresize=function(){b.initView();b.__apply()};b.onClickPacsImage=function(f,g){};b.onDblClickPacsImage=function(f,g){if(b.selView){b.selView.setSeries(f)}};b.onLayoutxXx=function(f,g){if(b.layout!=f){b.layout=f;b.initLayout()}};b.mouseup=function(j){d("$scope mouseup");var h=b.vViews;var f=h.length;for(var g=0;g<f;g++){if(h[g].mouseup){h[g].mouseup(j,true)}}};$(document).mouseup(b.mouseup);b.keydown=function(f){d("pacs keydown ctrlKey:"+f.ctrlKey+" altKey:"+f.altKey+" altKey:"+f.altKey+" shiftKey:"+f.shiftKey+" keyCode:"+f.keyCode);if(!b.selView){if(f.keyCode>=33&&f.keyCode<=40){f.preventDefault()}else{if(f.keyCode==27){f.preventDefault()}}return}switch(f.keyCode){case 27:b.cancelDrawing(true);break;case 33:b.selView.changeImage(-5);break;case 35:b.selView.changeImage(10000);break;case 36:b.selView.changeImage(-10000);break;case 37:case 38:b.selView.changeImage(-1);break;case 34:b.selView.changeImage(5);break;case 39:case 40:b.selView.changeImage(1);break;default:return}f.preventDefault()};$(document).keydown(b.keydown);b.keyup=function(f){switch(f.keyCode){case 33:case 37:case 38:case 34:case 39:case 40:f.preventDefault();break;default:break}};$(document).keyup(b.keyup);b.$rightWrapper=$(b.rightWrapper);b.selectDropMenu2=function(j,f){var g=$(".dropdown-menu>li."+f);g.removeClass(f);var h=$(j);h.addClass(f)};b.selectDropMenu=function(h,f){var g=$(".dropdown-menu>li."+f);g.removeClass(f);$(h.target.parentElement).addClass(f);h.target.blur()};b.selectMenu=function(h,f,g){if(g){$(h.target.parentElement).addClass(f)}else{$(h.target.parentElement).removeClass(f)}h.target.blur()};b.onAction=function(f,g){b.tools.tool=f;b.selectDropMenu(g,"sel-menu");g.target.blur()};b.onMeter=function(f,g){b.tools.tool=f;b.selectDropMenu(g,"sel-menu");g.target.blur()};b.onSelect=function(f,g){b.tools.tool=f;b.selectDropMenu(g,"sel-menu");g.target.blur()};b.onMark=function(g,f){b.tools.tool=g;b.selectDropMenu(f,"sel-menu");f.target.blur()};b.onRotate=function(f,g){g.target.blur();if(!b.selView){return}switch(f){case RotateTool.H:b.selView.flip(true);break;case RotateTool.V:b.selView.flip(false);break;case RotateTool.CW:b.selView.rotate(90);break;case RotateTool.CCW:b.selView.rotate(-90);break;default:break}};b.onInvert=function(f){if(b.selView){b.selView.invert()}f.target.blur()};b.onSetWl=function(h,f,g){if(b.selView){if(undefined==h){b.selView.setWwc(null)}else{b.selView.setWwc({ww:h,wc:f})}}g.target.blur()};b.onSetWl2=function(h,g,f){b.onSetWl(g-h,(h+g)/2,f)};b.onSetLut=function(f,g){if(b.selView){if(undefined==f){b.selView.setLut(null)}else{b.selView.setLut(f)}}g.target.blur()};b.onSetFilter=function(f,g){if(b.selView){if(undefined==f){b.selView.setFilter(null)}else{b.selView.setFilter(f)}}g.target.blur()};b.onReset=function(f,g){if(b.selView){b.selView.reset(f)}g.target.blur()};b.onLink=function(f){b.tools.linked=!b.tools.linked;if(!b.menuLink){b.menuLink=$("#li-link")}b.selectEl("#li-link","sel-menu5",b.tools.linked);f.target.blur()};b.onShowRuler=function(k){var j=b.vViews;var g=j.length;var f;b.tools.showRuler=!b.tools.showRuler;for(var h=0;h<g;h++){f=j[h];f.redraw(false)}if(!b.menuRuler){b.menuRuler=$("#li-show-ruler")}b.selectEl("#li-show-ruler","sel-menu5",b.tools.showRuler);k.target.blur()};b.onShowCTInfo=function(k){var j=b.vViews;var g=j.length;var f;b.tools.showInfo=!b.tools.showInfo;for(var h=0;h<g;h++){f=j[h];f.updateInfo()}b.selectEl("#li-show-info","sel-menu5",b.tools.showInfo);k.target.blur()};b.onMPR=function(j){j.target.blur();if(!this.series||!this.series.length){alert("无数据:(");return}if(!b.selView||!b.selView.series||!this.selView.series.images){alert("无数据:(");return}if(this.selView.series.images.length<5){alert("图片太少:(");return}if(b.selView.isVrMode()){alert("VR序列无法显示MPR:(");return}var h=PACS.MPRCheck(b.selView.series);if(true!=h){alert(h);return}if(!(b.layout>=301&&b.layout<=304)){b.layout=301;b.initLayout()}b.tools.tool=ActionTool.MPR;b.selectDropMenu2("#dli-mpr","sel-menu");var f;if(b.selView.series.mpr){f=b.selView.series.mpr;setTimeout(function(){f.onLoadDone()},0)}else{var f=new PACS.MPR(b.selView.series);var g=b.series.length;f.seriesX.index=g;b.series[g++]=f.seriesX;f.seriesY.index=g;b.series[g++]=f.seriesY;setTimeout(function(){f.createImages(function(k){if(!k){return}var l=document.getElementById("s-canvas-"+f.seriesX.index);if(l){f.seriesX.drawThumb(l)}var l=document.getElementById("s-canvas-"+f.seriesY.index);if(l){f.seriesY.drawThumb(l)}})},0)}b.vViews[0].setSeries(b.selView.series);b.vViews[1].setSeries(f.seriesX);b.vViews[2].setSeries(f.seriesY)};b.onVR=function(h){h.target.blur();if(!this.series||!this.series.length){alert("无数据:(");return}if(!b.selView||!b.selView.series||!this.selView.series.images){alert("无数据:(");return}if(this.selView.series.images.length<5){alert("图片太少:(");return}var g=PACS.MPRCheck(b.selView.series);if(true!=g){alert(g);return}b.tools.tool=ActionTool.VR;b.selectDropMenu2("#dli-vr","sel-menu");var f;if(b.selView.vr){}else{var f=new PACS.VR(b.selView.series);b.selView.vr=f;b.selView.redraw(true)}};b.wsConnect=function(j){var g=b;var h=baseUrl+"dcmsync";h=h.replace("http://","ws://");h=h.replace("https://","ws://");if(b.webSocket){b.webSocket.close()}var f=new WebSocket(h);b.webSocket=f;f.sendMsg=function(k,n,l){var m={type:k,id:n,content:l};f.send(JSON.stringify(m))};f.onopen=function(){d("ws open")};f.handleResult=function(k){switch(k.srcType){case"join":this.group=k.content.group;break;case"bc":break;case"uc":break}};f.onmessage=function(k){d(k);d("ws onmessage : "+k.data);var l=JSON.parse(k.data);switch(l.type){case"hello":f.id=l.id;if(!this.group){f.sendMsg("join",f.id,{group:"haha"})}break;case"result":f.handleResult(l);break;default:break}};f.onclose=function(k){d(k);d("ws onclose")}};b.onTest=function(){var l=1000000000;var k,f;var h=0;var m=0;var g;var n=new Uint8ClampedArray(l);var o=new Date().getTime();for(k=0;k<l;k++){h+=k*8+(k-6)*h/17;if(h>10000){h=0}m++}console.log("test data takes "+(new Date().getTime()-o)+"ms s:"+l+" count:"+m+" t:"+h)};b.wsConnect(null);ctrlExtend(b)});pacsApp.config(["$routeProvider","$httpProvider","$locationProvider",function(b,c,a){b.when("/",{title:""}).when("/xxxxxxxxx",{title:"",templateUrl:"./views/pacs/xxxx.html",controller:"setPwdCtrl"}).otherwise({redirectTo:"/"});c.defaults.useXDomain=true;delete c.defaults.headers.common["X-Requested-With"];c.defaults.headers.common["Content-Type"]="application/json";c.defaults.headers.common["app-key"]="fb98ab9159f51fd0"}]);pacsApp.factory("AppData",function(){return{data:{}}});pacsApp.run(["$location","$rootScope",function(b,a){a.$$Mark="I am root scope";a.$on("$routeChangeSuccess",function(c,e){if(e.$$route&&e.$$route.title){a.title=e.$$route.title;document.title=e.$$route.title}})}]);