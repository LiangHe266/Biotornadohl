PACS.MaxLinePoints=100;PACS.MaxPencilPoints=100;PACS.DrawObject=function(e,b,a,c){if(!(this instanceof PACS.DrawObject)){return new PACS.DrawObject(e,b,a,c)}this.imageData=e;this.mousedown(b,a,c)};PACS.DrawObject.prototype.mousedown=function(b,a,e){d("mousedown x:"+a+" y:"+e);if(this.done){this.trysel(a,e);return}if(this.type){if(this.tryend(a,e,true)){this.lastInitTime=(new Date()).getTime();return}}this.type=b;this.done=false;this.moved=false;this.selected=false;this.selectPoint=-1;this.lastInitTime=(new Date()).getTime();switch(b){case MeterTool.LINE:case SelectTool.RECT:case SelectTool.CIRCLE:case MarkTool.ARROW:case MarkTool.CIRCLE:case MarkTool.RECT:this.points=[a,e,a,e];break;case MeterTool.ANGLE:this.points=[a,e,a,e,0,0];break;case MeterTool.COBB_ANGLE:this.points=[a,e,a,e,0,0,0,0];break;case SelectTool.POLYGON:case MarkTool.FOLD_LINE:case MarkTool.PENCIL:this.points=new Array(PACS.MaxPencilPoints*2+2);this.points[0]=a;this.points[1]=e;this.curPoints=this.points;break;case MarkTool.TEXT:var c=prompt("请输入文字内容","");if(c){this.text=c}else{this.text=null}this.points=[a,e,a,e];break;dedault:return}this.pNum=1;return};PACS.DrawObject.prototype.mousemove=function(a,f){this.moved=true;if(this.done){var e=this.selectPoint;if(this.selected&&e>=0){this.points[e*2]=a;this.points[e*2+1]=f}return}switch(this.type){case MeterTool.LINE:case SelectTool.RECT:case SelectTool.CIRCLE:case MarkTool.ARROW:case MarkTool.CIRCLE:case MarkTool.RECT:this.points[2]=a;this.points[3]=f;break;case MeterTool.ANGLE:if(1==this.pNum){this.points[2]=a;this.points[3]=f}else{if(2==this.pNum){this.points[4]=a;this.points[5]=f}}break;case MeterTool.COBB_ANGLE:if(1==this.pNum){this.points[2]=a;this.points[3]=f}else{if(2==this.pNum){this.points[4]=a;this.points[5]=f}else{if(3==this.pNum){this.points[6]=a;this.points[7]=f}}}break;case SelectTool.POLYGON:case MarkTool.FOLD_LINE:if(this.pNum<PACS.MaxLinePoints-1){this.points[this.pNum*2]=a;this.points[this.pNum*2+1]=f}break;case MarkTool.PENCIL:if(this.pNum<PACS.MaxPencilPoints){this.curPoints[this.pNum*2]=a;this.curPoints[this.pNum*2+1]=f;this.pNum++}else{var c=PACS.MaxPencilPoints*2;var b=new Array(c+1);this.curPoints[c]=b;this.curPoints=b;this.curPoints[0]=a;this.curPoints[1]=f;this.pNum=1}break;case MarkTool.TEXT:this.points[2]=a;this.points[3]=f;break;dedault:break}return};PACS.DrawObject.prototype.mouseup=function(a,b){d("mouseup x:"+a+" y:"+b);this.moved=false;if(this.selected){this.selected=false;return}if(this.lastDistance(a,b)<4&&this.deltaInitTime()<200){switch(this.type){case MarkTool.PENCIL:break;default:return}}this.tryend(a,b,false)};PACS.DrawObject.prototype.end=function(a,b){d("end x:"+a+" y:"+b);if(this.type!=MarkTool.PENCIL){this.points[this.pNum*2]=a;this.points[this.pNum*2+1]=b;this.pNum+=1}this.done=true;this.selected=false};PACS.DrawObject.prototype.trysel=function(g,e){var j,f;var b=this.pNum;var c=-1;var h=10000;var k;switch(this.type){case SelectTool.POLYGON:case MarkTool.FOLD_LINE:return false;case MarkTool.TEXT:return false;case MarkTool.PENCIL:default:return false}for(var a=0;a<b;a++){k=distance(this.points[a*2],this.points[a*2+1],g,e);if(k<10){if(k<h){h=k;c=a}}}d("select minIdx:"+c);if(c>=0){this.selected=true;this.selectPoint=c;return true}return false};PACS.DrawObject.prototype.tryend=function(a,f,e){switch(this.type){case MeterTool.LINE:case SelectTool.RECT:case SelectTool.CIRCLE:case MarkTool.ARROW:case MarkTool.CIRCLE:case MarkTool.RECT:if(this.pNum==1&&this.lastDistance(a,f)>2){this.end(a,f);return true}break;case MeterTool.ANGLE:if(this.pNum==1){this.points[2]=a;this.points[3]=f;this.points[4]=a;this.points[5]=f;this.pNum=2;return true}else{if(this.pNum==2){this.end(a,f);return true}}break;case MeterTool.COBB_ANGLE:if(this.pNum==1){this.points[2]=a;this.points[3]=f;this.pNum=2;return true}else{if(this.pNum==2){this.points[4]=a;this.points[5]=f;this.points[6]=a;this.points[7]=f;this.pNum=3;return true}else{if(this.pNum==3){this.end(a,f);return true}}}break;case SelectTool.POLYGON:case MarkTool.FOLD_LINE:if(!e){break}var c=this.lastDistance(a,f);if(this.lastInitTime){var b=this.deltaInitTime();d("init delta time : "+b+" distance:"+c);if(c<4){this.end(a,f);return true}}if(this.pNum<PACS.MaxLinePoints-1){this.points[this.pNum*2]=a;this.points[this.pNum*2+1]=f;this.pNum+=1}else{this.points[this.pNum*2-2]=a;this.points[this.pNum*2-1]=f;this.points[this.pNum*2+0]=a;this.points[this.pNum*2+1]=f}return true;case MarkTool.PENCIL:if(e){break}this.end(a,f);return true;case MarkTool.TEXT:this.end(a,f);return true;default:break}return false};PACS.DrawObject.prototype.deltaInitTime=function(a,b){if(this.lastInitTime){return((new Date()).getTime()-this.lastInitTime)}return 0};PACS.DrawObject.prototype.isValid=function(){if(!this.type){return false}switch(this.type){case MarkTool.TEXT:return null!=this.text;default:break}return true};PACS.DrawObject.prototype.lastDistance=function(a,c){if(!this.pNum){return 0}var b=distance(this.points[this.pNum*2-2],this.points[this.pNum*2-1],a,c);d("lastDistance : "+this.points[this.pNum*2-2]+","+this.points[this.pNum*2-1]+" ,"+a+","+c+" dis:"+b);return b};PACS.DrawObject.prototype.draw=function(r){var t=this.points;switch(this.type){case MeterTool.LINE:var o=this.imageData.image;var f=false;var g,e;if(o.columnPixelSpacing&&o.rowPixelSpacing){g=o.columnPixelSpacing;e=o.rowPixelSpacing}else{g=1;e=1;f=true}r.drawMLine(t[0],t[1],t[2],t[3],g,e,(f?"pixel":"mm"));break;case MeterTool.ANGLE:r.moveTo(t[2],t[3]);r.lineTo(t[0],t[1]);if(this.pNum>=2){r.lineTo(t[4],t[5]);var b=calcAngle(t[0],t[1],t[2],t[3]);var a=calcAngle(t[0],t[1],t[4],t[5]);var b=parseInt(Math.abs(a-b)*100);if(b>18000){b=36000-b}a=(36000-b)/100;b/=100;r.fillText("@"+(b)+"("+a+")",t[0],t[1],0,-5)}break;case MeterTool.COBB_ANGLE:r.moveTo(t[2],t[3]);r.lineTo(t[0],t[1]);if(this.pNum>2){r.moveTo(t[4],t[5]);r.lineTo(t[6],t[7]);var b=calcAngle(t[0],t[1],t[2],t[3]);var a=calcAngle(t[4],t[5],t[6],t[7]);b=parseInt(Math.abs(a-b)*100);if(isNaN(b)){b=0}if(b>18000){b=36000-b}a=(36000-b)/100;b/=100;r.fillText("@"+(b)+"("+a+")",t[0],t[1],0,-5)}break;case SelectTool.RECT:var m=(t[2]-t[0]);var l=(t[3]-t[1]);r.rect(t[0],t[1],m,l);break;case SelectTool.CIRCLE:var m=(t[2]-t[0])/2;var l=(t[3]-t[1])/2;r.drawEllipse(t[0]+m,t[1]+l,m,l);break;case SelectTool.POLYGON:var h=this.pNum*2;r.moveTo(t[0],t[1]);var u=2;for(;u<h;u+=2){r.lineTo(t[u],t[u+1])}if(this.done){r.lineTo(t[0],t[1])}else{r.lineTo(t[u],t[u+1])}break;case MarkTool.ARROW:r.moveTo(t[0],t[1]);r.lineTo(t[2],t[3]);var m=(t[2]-t[0]);var l=(t[3]-t[1]);if(m!=0||l!=0){var p=Math.sqrt(m*m+l*l);if(p>4){var w=(4*l/p);var v=(4*m/p);var s=(10*m/p);var q=(10*l/p);r.moveTo(t[0]+w+s,t[1]-v+q);r.lineTo(t[0],t[1]);r.lineTo(t[0]-w+s,t[1]+v+q)}}break;case MarkTool.TEXT:r.fillText(this.text,t[2],t[3],0,0);break;case MarkTool.CIRCLE:var m=(t[2]-t[0])/2;var l=(t[3]-t[1])/2;r.drawEllipse(t[0]+m,t[1]+l,m,l);break;case MarkTool.RECT:var m=(t[2]-t[0]);var l=(t[3]-t[1]);r.rect(t[0],t[1],m,l);break;case MarkTool.FOLD_LINE:var h=this.pNum*2;r.moveTo(t[0],t[1]);for(var u=2;u<h;u+=2){r.lineTo(t[u],t[u+1])}if(this.done){r.lineTo(t[0],t[1])}else{r.lineTo(t[u],t[u+1])}break;case MarkTool.PENCIL:var c=t.length;var u=2;var k,j;var n=false;r.moveTo(t[0],t[1]);while(true){for(;u<c;u+=2){k=t[u];j=t[u+1];if(undefined==k||undefined==j){n=true;break}r.lineTo(k,j)}t=t[PACS.MaxPencilPoints*2];if(!t){break}else{u=0}}break}};