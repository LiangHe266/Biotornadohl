PACS.Image=function(){};PACS.Image.DefaultWwc=function(){var a={wc:40,ww:400};return a};PACS.Image.prototype.init=function(){if(!this instanceof PACS.Image){d("PACS.Image init")}if(!this.imageInfo||!this.dataSet){this.wwc=PACS.Image.DefaultWwc();return}var b=this.imageInfo;this.minPixelValue=b.minPixelValue;this.maxPixelValue=b.maxPixelValue;this.RescaleSlope=b.slope;this.RescaleIntercept=b.intercept;this.windowCenter=b.windowCenter;this.windowWidth=b.windowWidth;this.Rows=b.rows;this.Columns=b.columns;this.height=b.height;this.width=b.width;this.color=b.color;this.columnPixelSpacing=b.columnPixelSpacing;this.rowPixelSpacing=b.rowPixelSpacing;this.invert=b.invert;this.sizeInBytes=b.sizeInBytes;this.data=b.getPixelData();var a=this.dataSet;this.PhotometricInterpretation=a.string("x00280004");this.SliceThickness=a.floatString("x00180050");this.SliceLocation=a.floatString("x00201041");this.InstanceNumber=a.uint16("x00200013");this.PatientOrientation=a.string("x00200020");this.PatientPosition=a.string("x00185100");this.ImagePositionPatient=a.string("x00200032");this.ImageOrientationPatient=a.string("x00200037");this.AcquisitionDate=a.string("x00080022");this.AcquisitionTime=a.string("x00080032");this.AccessionNumber=a.string("x00080050");this.Modality=a.string("x00080060");this.PatientID=a.string("x00100020");this.PatientBirthDate=a.string("x00100030");this.NumberOfFrames=a.string("x00280008");this.FrameIncrementPointer=a.string("x00280009");this.MediaStorageSOPClassUID=a.string("x00020002");delete this.dataSet.byteArray;delete this.imageInfo;this.wwc=this.getWwc();switch(this.PhotometricInterpretation){case"MONOCHROME1":this.coefPhotInt=-1;default:this.coefPhotInt=1}};PACS.Image.prototype.mprInit=function(){if(!this instanceof PACS.Image){d("PACS.Image mprInit")}this.wwc=this.getWwc()};PACS.Image.prototype.__init=function(){if(this.inited){return}var j=this.width;var e=this.height;var l=j*e;var g=0;var a=0;var f=0;var k;var c=this.data;if(!c){return}for(var b=0;b<l;b++){k=c[b];if(k==63488){continue}f+=k;if(k<a){a=k}if(k>g){g=k}}this.minVar=a;this.maxVar=g;this.totalVar=f;this.inited=true};PACS.Image.prototype.getImageData=function(e,l,G){var m=this.width;var x=this.height;var F=this.data;var p=m*x;var z=e.createImageData(m,x);var u=z.data;if(undefined==l||undefined==G){var f=this.getWwc();l=f.wc;G=f.ww}var D=255;var q=this.coefPhotInt;var B=q*D/G;var A=D*(0.5-q*l/G);var c;var k=this.RescaleSlope;var o=this.RescaleIntercept;if(undefined!=k&&undefined!=o){B=B*k;A=B*o+A}if(this.color){var n,y,C,E;p*=4;for(var t=0;t<p;t+=4){n=F[t];y=F[t+1];C=F[t+2];E=F[t+3];n=B*n+A;y=B*y+A;C=B*C+A;u[t]=n;u[t+1]=y;u[t+2]=C;u[t+3]=E}}else{for(var t=0,s=0;t<p;t++,s+=4){v=F[t];v=B*v+A;u[s]=v;u[s+1]=v;u[s+2]=v;u[s+3]=255}}return z};PACS.Image.prototype.getValue=function(a,f){var e=this.data;if(!e){return"N/A"}var b=this.width;var c=f*b+a;if(c<0||c>=e.length){return"N/A"}return e[c]};PACS.Image.prototype.drawThumb=function(i){initCanvas(i);var e=i.getContext("2d");var a=this.getImageData(e);if(!a){return}var m=this.width;var k=this.height;var j=i.width;var b=i.height;var o=getScale(m,k,j,b);var g=parseInt(o*m);var l=parseInt(o*k);var f,c;f=(j-g)/2;c=(b-l)/2;var n=getTempCanvas();n.width=m;n.height=k;n.getContext("2d").putImageData(a,0,0);e.save();e.translate(f,c);e.scale(o,o);e.drawImage(n,0,0);e.restore()};PACS.Image.prototype.copyBasic=function(a){this.PatientName=a.PatientName;this.PatientBirthDate=a.PatientBirthDate;this.PatientID=a.PatientID;this.PatientSex=a.PatientSex;this.StudyInstanceUID=a.StudyInstanceUID;this.InstanceNumber=a.InstanceNumber;this.Modality=a.Modality;this.height=a.height;this.width=a.width;this.AcquisitionDate=a.AcquisitionDate;this.AcquisitionTime=a.AcquisitionTime;this.ContrastBolusAgent=a.ContrastBolusAgent;this.SliceThickness=a.SliceThickness;this.SliceLocation=a.SliceLocation;this.PhotometricInterpretation=a.PhotometricInterpretation;this.Columns=a.Columns;this.Rows=a.Rows;this.windowCenter=a.windowCenter;this.windowWidth=a.windowWidth;this.RescaleSlope=a.RescaleSlope;this.RescaleIntercept=a.RescaleIntercept;this.coefPhotInt=a.coefPhotInt};PACS.Image.prototype.getGrayData=function(b,c,n,o){var f=this.width;var t=this.height;var A=this.data;var m=f*t;var z=255;var p=this.coefPhotInt;var x=p*z/b.ww;var u=z*(0.5-p*b.wc/b.ww);var a;var g;var e=this.RescaleSlope;var l=this.RescaleIntercept;if(undefined!=e&&undefined!=l){x=x*e;u=x*l+u}var s,r,q;var y;for(s=0,q=0;s<t;s++){y=n+s*o;for(r=0;r<f;r++,q++){g=A[q];g=x*g+u;if(g<2){g=0}else{if(g>=255){g=255}else{}}c[y+r]=g}}return c};PACS.Image.prototype.getGrayData0=function(f,n,o,b){var r=this.width;var m=this.height;var l=this.data;var t=r*m;var j=255;var e=this.coefPhotInt;var c=e*j/f.ww;var a=j*(0.5-e*f.wc/f.ww);var p;var s;var g=this.RescaleSlope;var q=this.RescaleIntercept;if(undefined!=g&&undefined!=q){c=c*g;a=c*q+a}for(var k=0;k<t;k++){s=l[k];s=c*s+a;if(s<10){s=0}else{n[o+k]=s}}return n};PACS.Image.prototype.getWwc=function(a){var b=PACS.Image.DefaultWwc();if(!this.windowCenter){b.wc=41}else{if(this.windowCenter.length>0){b.wc=this.windowCenter[0]}else{b.wc=this.windowCenter}}if(!this.windowWidth){b.ww=410}else{if(this.windowWidth.length>0){b.ww=this.windowWidth[0]}else{b.ww=this.windowWidth}}return b};function extendPacsImage(b){var a=new PACS.Image();$.extend(b,a);b.init();return b};