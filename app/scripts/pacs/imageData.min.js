PACS.ImageData=function(b,a){if(!(this instanceof PACS.ImageData)){return new PACS.ImageData(b,a)}this.image=b;this.inverse=false;this.context=a;this.drawObjects=[];this.lastDrawObject=null;this.resetWwc()};PACS.ImageData.prototype.resetWwc=function(){var a=this.image.getWwc();return this.wwc=a};PACS.ImageData.prototype.reset=function(){this.resetWwc();this.drawObjects=[];this.lastDrawObject=null;this.lut=null;this.filter=null;this.inverse=false};PACS.ImageData.prototype.clearData=function(){if(this.imageData){ImageDataCache.put(this.imageData);this.imageData=null}};PACS.ImageData.prototype.invert=function(){if(!this.imageData){return}var f=this.imageData.data;var a=this.imageData.width;var e=this.imageData.height;var d=a*e*4;var b;for(var c=0;c<d;c+=4){b=f[c];b=255-b;f[c]=255-f[c];f[c+1]=255-f[c+1];f[c+2]=255-f[c+2]}this.inverse=!this.inverse};PACS.ImageData.prototype.initImageData=function(){var q=this.image;var l=q.width;var z=q.height;if(!this.imageData){this.imageData=ImageDataCache.getex(this.context,l,z)}var G=q.data;var p=l*z;var y=this.imageData.data;var E=255;var s=q.coefPhotInt;var C=s*E/this.wwc.ww;var B=E*(0.5-s*this.wwc.wc/this.wwc.ww);var m;var e=this.inverse;var k=q.RescaleSlope;var o=q.RescaleIntercept;if(undefined!=k&&undefined!=o){C=C*k;B=C*o+B}if(this.filter){var u=Uint8ClampedArrayCache.get(p,0);for(var x=0;x<p;x++){m=G[x];m=C*m+B;u[x]=m}G=this.filter.process(u,l,z);Uint8ClampedArrayCache.put(u);var d=this.lut;if(d){var f=d.bytes;var c;for(var x=0,t=0;x<p;x++,t+=4){m=G[x];if(e){m=255-m}c=f[m];y[t]=c[0];y[t+1]=c[1];y[t+2]=c[2];y[t+3]=255}}else{for(var x=0,t=0;x<p;x++,t+=4){m=G[x];if(e){m=255-m}y[t]=m;y[t+1]=m;y[t+2]=m;y[t+3]=255}}Uint8ClampedArrayCache.put(G)}else{if(q.color){p*=4;var n,A,D,F;for(var x=0;x<p;x+=4){n=G[x];A=G[x+1];D=G[x+2];F=G[x+3];n=C*n+B;A=C*A+B;D=C*D+B;y[x]=n;y[x+1]=A;y[x+2]=D;y[x+3]=F}}else{var d=this.lut;if(d){var f=d.bytes;var c;for(var x=0,t=0;x<p;x++,t+=4){m=G[x];m=C*m+B;if(m<0){m=0}else{if(m>255){m=255}else{m=parseInt(m)}}if(e){m=255-m}c=f[m];y[t]=c[0];y[t+1]=c[1];y[t+2]=c[2];y[t+3]=255}}else{for(var x=0,t=0;x<p;x++,t+=4){m=G[x];m=C*m+B;if(m<0){m=0}else{if(m>255){m=255}else{m=parseInt(m)}}if(e){m=255-m}y[t]=m;y[t+1]=m;y[t+2]=m;y[t+3]=255}}}}};PACS.ImageData.prototype.mousecaptrued=function(){var a=this.lastDrawObject;return(a&&!a.done)};PACS.ImageData.prototype.mousedown=function(c,a,e){var d=this.lastDrawObject;this.lastX=a;this.lastY=e;if(d&&!d.done){d.mousedown(c,a,e)}else{var b=new PACS.DrawObject(this,c,a,e);if(b.isValid()){this.drawObjects[this.drawObjects.length]=b;this.lastDrawObject=b}}return true};PACS.ImageData.prototype.mousemove=function(a,c){var b=this.lastDrawObject;this.lastX=a;this.lastY=c;if(b&&!b.done){b.mousemove(a,c);return true}return false};PACS.ImageData.prototype.mouseup=function(a,c){var b=this.lastDrawObject;if(b&&!b.done){if(undefined==a){a=this.lastX;c=this.lastY}b.mouseup(a,c);if(b.done){this.lastDrawObject=null}else{}return true}return false};PACS.ImageData.prototype.cancelDrawing=function(){var a=this.lastDrawObject;if(a&&!a.done){this.lastDrawObject=null;this.drawObjects.length=this.drawObjects.length-1;return true}return false};PACS.ImageData.prototype.draw0=function(a,d){a.putImageData(this.imageData,0,0);var e=this.drawObjects;var c=e.length;if(c){a.lineCap="round";a.lineJoin="round";a.lineWidth=1;a.strokeStyle="#F00";a.font="Bold 16px Arial";a.fillStyle="#F00";a.beginPath();for(var b=0;b<c;b++){if(e[b]){e[b].draw(a)}}a.stroke();for(var b=0;b<c;b++){if(e[b]){e[b].drawText(a,d)}}}};PACS.ImageData.prototype.draw=function(a,b){a.putImageData(this.imageData,0,0)};PACS.ImageData.prototype.drawObjs=function(e){var d=this.drawObjects;var c=d.length;if(c){var a=e.getContext();a.lineCap="round";a.lineJoin="round";a.lineWidth=1;a.strokeStyle="#F00";a.font="Bold 16px Arial";a.fillStyle="#F00";a.beginPath();e.init();for(var b=0;b<c;b++){if(d[b]){d[b].draw(e)}}a.stroke()}};