PACS.View=function(a,b){if(!(this instanceof PACS.View)){return new PACS.View(a,b)}this.listeners=b;this.canvasId=a+"-c";this.viewId=a;var c=this;setTimeout(function(){c.init()},10)};PACS.View.prototype.init=function(){if(!this.canvasId){return}this.canvas=document.getElementById(this.canvasId);this.context=this.canvas.getContext("2d");this.$canvas=$(this.canvas);this.shown=true;this.floatRight=false;this.selected=false;this.imgShown=false;this.tools=this.listeners.getTools();this.imageIndex=0;this.canvas.$PacsView=this;this.$canvas.$PacsView=this;this.drawCanvas=document.createElement("canvas");this.createCtxMenu();var b=document.getElementById(this.viewId);b.$PacsView=this;var c=$("#"+this.viewId+"");this.$wraper=c;this.$infolt=c.find(".image-info-lt>a");this.$infort=c.find(".image-info-rt>a");this.$infolb=c.find(".image-info-lb>a");this.$inforb=c.find(".image-info-rb>a");this.$slider=c.find(".image-info-lb>input");this.$slider.change(this.onSliderChanged);this.slider=this.$slider[0];this.slider.$PacsView=this;var a=this;this._mousedown=function(d){a.mousedown(d)};this._mousemove=function(d){a.mousemove(d)};this._mouseup=function(d){a.mouseup(d)};this._mouseout=function(d){a.mouseout(d)};this._mousewheel=function(d){a.mousewheel(d)};this.$canvas.on("mousedown",this._mousedown);this.$canvas.on("mousewheel",this._mousewheel)};PACS.View.prototype.isSelected=function(a){return this.selected?true:false};PACS.View.prototype.onClickCtxAction=function(b,a){};PACS.View.prototype.onClickCtxSeries=function(d,c){if(!this.length||!this[0].$PacsView){return}var a=this[0].$PacsView;if(a.listeners&&a.listeners.getSeries){var b=a.listeners.getSeries(d);if(b){a.setSeries(b)}}};PACS.View.prototype.createCtxMenu=function(){return;var d=this.canvas.id;if(this.ctxMenuInit){$("#"+d).contextMenu("destroy")}if(this.series){$.contextMenu({selector:"#"+d,callback:this.onClickCtxAction,items:pacsOprMenus});this.ctxMenuInit=2}else{if(this.listeners&&this.listeners.getSeries){var b=this.listeners.getSeries();if(b&&b.length>0){var c={};for(var a in b){c[a]={name:b[a].SeriesDescription,icon:"edit"}}$.contextMenu({selector:"#"+d,callback:this.onClickCtxSeries,items:c});this.ctxMenuInit=1}}}};PACS.View.prototype.deselectViews=function(b){var a=$("div.selected");a.each(function(){if(this.$PacsView){this.$PacsView.setSelected(false)}})};PACS.View.prototype._setSelected=function(a){if(!this.ctxMenuInit){this.createCtxMenu()}if(a){this.deselectViews();this.$wraper.addClass("selected")}else{this.$wraper.removeClass("selected")}this.selected=a;if(this.listeners&&this.listeners.onSelected){this.listeners.onSelected(this,a)}};PACS.View.prototype.setSelected=function(a){if(a==this.selected){return}this._setSelected(a)};PACS.View.prototype.enablemouse=function(a){$(document).on("mousemove",this._mousemove);$(document).on("mouseup",this._mouseup)};PACS.View.prototype.disablemouse=function(a){$(document).off("mousemove",this._mousemove);$(document).off("mouseup",this._mouseup)};PACS.View.prototype.mousedown=function(g){this.mbtn=g.button;this.mdown=true;if(!this.selected){this.setSelected(true)}console.log("mousedown @ "+this.canvasId+" offset ox : "+g.clientX+" oy : "+g.clientY);if(!this.imageData){return}if(this.mbtn==0){switch(this.getTools()){case ActionTool.NONE:case ActionTool.SCOLL:case ActionTool.WL:case ActionTool.MOVE:case ActionTool.ZOOM:case ActionTool.MPR:case ActionTool.CT:case ActionTool.VR:this.mox=g.clientX;this.moy=g.clientY;this.initmox=g.clientX;this.initmoy=g.clientY;this.mdown=true;this.mmove=false;if(ActionTool.NONE==this.getTools()){if(this.isMprMode()){this.setMprPoint(g.offsetX,g.offsetY)}}else{if(ActionTool.ZOOM==this.getTools()){if(this.drawInfo){this.initofsx=g.offsetX;this.initofsy=g.offsetY}}else{if(ActionTool.CT==this.getTools()){var h=this.drawInfo;var f=this.drawCanvas.width;var a=this.drawCanvas.height;var b=this.axescvt(g.offsetX,g.offsetY);var d=Math.round(b[0]);var c=Math.round(b[1]);if(d<0||d>=this.image.width||c<0||c>=this.image.height){this.showCtValue("No Value - Outside image")}else{var i=this.image.getValue(d,c);this.showCtValue(i+"HU&nbsp;("+d+","+c+")")}}}}break;default:var j=this.axescvt(g.offsetX,g.offsetY);if(this.imageData.mousedown(this.getTools(),j[0],j[1])){this.redraw(false)}break}this.enablemouse();return}this.mox=g.clientX;this.moy=g.clientY;this.initmox=g.clientX;this.initmoy=g.clientY;this.mdown=true;this.mmove=false;this.enablemouse();return};PACS.View.prototype.mouseup=function(b,a){if(a){if(b.target=this.canvas){}}console.log("mouseup @ "+this.canvasId+" offset ox : "+b.clientX+" oy : "+b.clientY);if(0==this.mbtn){if(this.imageData&&this.imageData.mousecaptrued()){if(this.imageData.mouseup()){this.redraw(false)}this.mdown=false;this.mbtn=-1}}this.mdown=false;this.mbtn=-1;if(!this.imageData.mousecaptrued()){this.disablemouse()}};PACS.View.prototype.mousemove=function(h){h.preventDefault();if(!this.imageData){return}if(this.imageData.mousecaptrued()){if(h.target==this.canvas){var n=this.axescvt(h.offsetX,h.offsetY);if(this.imageData.mousemove(n[0],n[1])){this.redraw(false)}}return}if(!this.mdown){return}if(this.mbtn==0){switch(this.getTools()){case ActionTool.SCOLL:if(h.clientY-this.moy>20){this.moy=h.clientY;this.nextImage()}else{if(h.clientY-this.moy<-20){this.moy=h.clientY;this.prevImage()}}break;case ActionTool.WL:if(Math.abs(h.clientY-this.moy)+Math.abs(h.clientX-this.mox)<3){break}this.imageData.wwc.wc-=(h.clientY-this.moy);if(this.imageData.wwc.wc<this.imageData.min){this.imageData.wwc.wc=this.imageData.min}else{if(this.imageData.wwc.wc>this.imageData.max){this.imageData.wwc.wc=this.imageData.max}}this.imageData.wwc.ww+=(h.clientX-this.mox);if(this.imageData.wwc.ww<1){this.imageData.wwc.ww=1}else{if(this.imageData.wwc.ww>(this.imageData.max-this.imageData.min)){this.imageData.wwc.ww=(this.imageData.max-this.imageData.min)}}this.mox=h.clientX;this.moy=h.clientY;this.wlInfo=this.imageData.wwc;this.updateWLInfo();this.redraw(true);break;case ActionTool.MOVE:if(!this.drawInfo){break}this.drawInfo.ox+=(h.clientX-this.mox);this.drawInfo.oy+=(h.clientY-this.moy);this.mox=h.clientX;this.moy=h.clientY;this.updateDwWraper();this.draw();break;case ActionTool.ZOOM:if(!this.drawInfo){break}var c=this.drawInfo.scale;this.drawInfo.scale+=(h.clientY-this.moy)/200*(1+c);if(this.drawInfo.scale*this.imageData.imageData.height<this.canvas.height/20){this.drawInfo.scale=this.canvas.height/20/this.imageData.imageData.height}else{if(this.drawInfo.scale*this.imageData.imageData.height>this.canvas.height*20){this.drawInfo.scale=this.canvas.height*20/this.imageData.imageData.height}}var l=this.initofsx-this.drawInfo.ox;var j=this.initofsy-this.drawInfo.oy;var o=l/c*this.drawInfo.scale;var m=j/c*this.drawInfo.scale;this.drawInfo.ox-=o-l;this.drawInfo.oy-=m-j;this.moy=h.clientY;this.updateDwWraper();this.draw();this.updateZoomInfo();break;case ActionTool.CT:if(h.target!=this.canvas){break}var i=this.drawInfo;var g=this.drawCanvas.width;var a=this.drawCanvas.height;var b=this.axescvt(h.offsetX,h.offsetY);var f=Math.round(b[0]);var d=Math.round(b[1]);if(f<0||f>=this.image.width||d<0||d>=this.image.height){this.showCtValue("No Value - Outside image")}else{var k=this.image.getValue(f,d);this.showCtValue(k+"HU&nbsp;("+f+","+d+")")}break;case ActionTool.NONE:case ActionTool.MPR:case ActionTool.VR:if(this.isMprMode()){if(h.target==this.canvas){this.setMprPoint(h.offsetX,h.offsetY)}}else{if(this.isVrMode()){}}break;default:break}return}if(this.mbtn==1){if(!this.drawInfo){return}var c=this.drawInfo.scale;this.drawInfo.scale+=(h.clientY-this.moy)/200*(1+c);if(this.drawInfo.scale*this.imageData.imageData.height<this.canvas.height/20){this.drawInfo.scale=this.canvas.height/20/this.imageData.imageData.height}else{if(this.drawInfo.scale*this.imageData.imageData.height>this.canvas.height*20){this.drawInfo.scale=this.canvas.height*20/this.imageData.imageData.height}}var o=(this.drawInfo.scale-c)*this.imageData.imageData.width;var m=(this.drawInfo.scale-c)*this.imageData.imageData.height;this.drawInfo.ox-=o/2;this.drawInfo.oy-=m/2;this.moy=h.clientY;this.draw();this.updateZoomInfo();return}if(this.mbtn==2){if(Math.abs(h.clientY-this.moy)+Math.abs(h.clientX-this.mox)<3){return}this.imageData.wwc.wc-=(h.clientY-this.moy);if(this.imageData.wwc.wc<this.imageData.min){this.imageData.wwc.wc=this.imageData.min}else{if(this.imageData.wwc.wc>this.imageData.max){this.imageData.wwc.wc=this.imageData.max}}this.imageData.wwc.ww+=(h.clientX-this.mox);if(this.imageData.wwc.ww<1){this.imageData.wwc.ww=1}else{if(this.imageData.wwc.ww>(this.imageData.max-this.imageData.min)){this.imageData.wwc.ww=(this.imageData.max-this.imageData.min)}}this.mox=h.clientX;this.moy=h.clientY;this.wlInfo=this.imageData.wwc;this.updateWLInfo();this.redraw(true);return}};PACS.View.prototype.mouseout=function(a){console.log("mouseout @ "+this.canvasId+" offset ox : "+a.clientX+" oy : "+a.clientY);if(!this.mdown){return}switch(this.tools){case ActionTool.CT:this.showCtValue("No Value - Outside image");default:return}};PACS.View.prototype.setMprPoint=function(a,c){var b=this.axescvt(a,c);this.series.setImgPoint(Math.round(b[0]),Math.round(b[1]))};PACS.View.prototype.isMprMode=function(){return this.series&&this.series.isMprMode()};PACS.View.prototype.isVrMode=function(){return this.vr};PACS.View.prototype.syncLinked=function(a){this.changeImage(a,true)};PACS.View.prototype.changeImage=function(e,d,c){if(!this.series||!this.series.images){return}var b=!c;var a=this.imageIndex+e;if(a<0){if(b){a=this.series.images.length-1}else{a=0}}else{if(a>=this.series.images.length){if(b){a=0}else{a=this.series.images.length-1}}}if(this.imageIndex==a&&!d){return}if(this.isMprMode()){if(!d){if(this.tools.linked){if(this.listeners.syncLinked){this.listeners.syncLinked(this,e)}}this.series.setImgIdx(a,true);return}}else{if(!d&&this.tools.linked){if(this.listeners.syncLinked){this.listeners.syncLinked(this,e)}}}if(d&&this.isMprMode()){this.series.setImgIdx(a,false)}this.setImageIdx(a)};PACS.View.prototype.prevImage=function(){this.changeImage(-1)};PACS.View.prototype.nextImage=function(){this.changeImage(1)};PACS.View.prototype.mousewheel=function(d,f){if(!this.selected){return}if(!this.series){return}if(1){if(d.originalEvent.deltaY>0){this.nextImage()}else{this.prevImage()}return}switch(this.getTools()){case ActionTool.SCOLL:if(d.originalEvent.deltaY>0){this.setImageIdx(this.imageIndex+1)}else{this.setImageIdx(this.imageIndex-1)}break;case ActionTool.WL:if(!this.imageData){break}if(d.originalEvent.deltaY>0){if(this.imageData.wwc.wc>this.imageData.min){this.imageData.wwc.wc-=50}}else{if(this.imageData.wwc.wc<this.imageData.max){this.imageData.wwc.wc+=50}}this.wlInfo=this.imageData.wwc;this.updateWLInfo();this.redraw(true);break;case ActionTool.ZOOM:if(!this.drawInfo){break}var c=this.drawInfo.scale;if(d.originalEvent.deltaY>0){this.drawInfo.scale+=0.1*(1+c)}else{this.drawInfo.scale-=0.1*(1+c)}if(this.drawInfo.scale*this.imageData.imageData.height<this.canvas.height/20){this.drawInfo.scale=this.canvas.height/20/this.imageData.imageData.height}else{if(this.drawInfo.scale*this.imageData.imageData.height>this.canvas.height*20){this.drawInfo.scale=this.canvas.height*20/this.imageData.imageData.height}}var b=(this.drawInfo.scale-c)*this.imageData.imageData.width;var a=(this.drawInfo.scale-c)*this.imageData.imageData.height;this.drawInfo.ox-=b/2;this.drawInfo.oy-=a/2;this.moy=d.clientY;this.updateDwWraper();this.draw();this.updateZoomInfo();break}};PACS.View.prototype.onSliderChanged=function(b){if(!(this instanceof PACS.View)){if(this.$PacsView){this.$PacsView.onSliderChanged(b)}return}var a=b.target.value-1;if(a!=this.imageIndex){this.changeImage(a-this.imageIndex)}};PACS.View.prototype.show=function(a){if(this.shown&&this.floatRight==a){return}this.shown=true;this.$canvas.removeClass("hide");if(this.floatRight!=a){this.floatRight=a;if(a){this.$wraper.css("float","right")}else{this.$wraper.css("float","true")}}else{}};PACS.View.prototype.setSize=function(c,a){if(!this.shown){return}var b=this.canvas.width;var d=this.canvas.height;this.$canvas.width(c);this.$canvas.height(a);this.canvas.width=c;this.canvas.height=a;if(this.isVrMode()){this.vr.setSize(c,a);return}if(this.drawInfo){$.extend(this.drawInfo,calcScale(this.image,this.canvas));this.updateDwWraper()}this.draw();this.updateZoomInfo()};PACS.View.prototype.hide=function(){if(!this.shown){return}if(this.series){}this.shown=false;this.$canvas.addClass("hide")};PACS.View.prototype.onImageLoaded=function(b,a,c){if(this.isMprMode()){}if(this.imageIndex==a){this.setImageIdx(a)}};PACS.View.prototype.getImageDataCache=function(a){if(this.imageDataCache){return this.imageDataCache[a]}return null};PACS.View.prototype.setImageDataCache=function(a,b){if(!this.imageDataCache){this.imageDataCache=new Array(this.series.images.length)}b.clearData();this.imageDataCache[a]=b};PACS.View.prototype.setSeries=function(b){if(b==this.series){return}this.playImage(false);if(this.series){this.series.removeView(this);this.resetDwinfo();delete this.imageData;delete this.imageDataCache;this.imageData=null;this.imageDataCache=null;this.image=null}this.series=b;if(b){b.addView(this);var a=0;if(b.isMprMode()){a=b.getImgIdx()}this.setImageIdx(a)}else{this.drawBgd();this.updateInfo()}var c=this;if(this.ctxMenuInit!=2){}if(this.selected){this._setSelected(true)}};PACS.View.prototype.updateZoomInfo=function(){if(this.image&&this.tools.showInfo){this.$infolb[2].innerHTML="Zoom:&nbsp;"+this.getZoom()+"%"}else{this.$infolb[2].innerHTML=""}};PACS.View.prototype.updateWLInfo=function(){if(this.image&&this.tools.showInfo){this.$infolb[3].innerHTML="Window/Level:&nbsp;"+this.imageData.wwc.ww+"/"+this.imageData.wwc.wc}else{this.$infolb[3].innerHTML=""}};PACS.View.prototype.showCtValue=function(a){if(a){this.$infolb[0].innerHTML="Pixel:&nbsp;"+a}else{this.$infolb[0].innerHTML=""}};PACS.View.prototype.updateInfo=function(){var b=this.image;var a=this.series;if(!b||!this.tools.showInfo||this.isVrMode()){this.$infolt.text("");this.$infort.text("");this.$infolb.text("");this.$inforb.text("");this.slider.style.visibility="hidden"}else{this.$infolt[0].innerHTML=b.PatientName;this.$infolt[1].innerHTML=b.PatientBirthDate;this.$infolt[2].innerHTML="ID:&nbsp;"+b.PatientID;if(b.PatientSex=="F"){this.$infolt[3].innerHTML="SEX:&nbsp;Female"}else{if(b.PatientSex=="M"){this.$infolt[3].innerHTML="SEX:&nbsp;Male"}else{this.$infolt[3].innerHTML="SEX:&nbsp;Other"}}this.$infolt[4].innerHTML=calcAgeByBdate(b.PatientBirthDate)+" Years";this.$infort[0].innerHTML=a.InstitutionName;this.$infort[1].innerHTML="Study ID:&nbsp;"+getSplitR(b.StudyInstanceUID,".",0);if(b.dataSet){this.$infort[2].innerHTML="Ac. Nb.:&nbsp;"+b.AccessionNumber;this.$infort[3].innerHTML="Acq.:&nbsp;"+b.AcquisitionDate;this.$infort[4].innerHTML="Acq.:&nbsp;"+b.AcquisitionTime}else{this.$infort[2].innerHTML="";this.$infort[3].innerHTML="";this.$infort[4].innerHTML=""}this.$infolb[0].innerHTML="";this.$infolb[1].innerHTML="Frame:&nbsp;["+b.InstanceNumber+"]&nbsp;"+(this.imageIndex+1)+"/"+a.images.length;this.$infolb[2].innerHTML="Zoom:&nbsp;"+this.getZoom()+"%";if(this.imageData){this.$infolb[3].innerHTML="Window/Level:&nbsp;"+this.imageData.wwc.ww+"/"+this.imageData.wwc.wc}else{this.$infolb[3].innerHTML=""}if(b.dataSet){this.$infolb[4].innerHTML=b.Modality+"&nbsp;("+b.Columns+"*"+b.Rows+")"}else{this.$infolb[4].innerHTML=""}this.slider.max=a.images.length-1;this.slider.min=0;this.slider.value=this.imageIndex;this.slider.style.visibility="visible";if(b.Modality=="CT"){this.$inforb[0].innerHTML="Series No: "+a.SeriesNumber;this.$inforb[2].innerHTML=this.series.SeriesDescription;if(b.dataSet){this.$inforb[1].innerHTML=b.ContrastBolusAgent;this.$inforb[3].innerHTML="Thickness: "+b.SliceThickness+"mm";this.$inforb[4].innerHTML="Location: "+b.SliceLocation+"mm"}else{this.$inforb[1].innerHTML="";this.$inforb[3].innerHTML="";this.$inforb[4].innerHTML=""}}else{this.$inforb[0].innerHTML="";this.$inforb[1].innerHTML="";this.$inforb[2].innerHTML="";this.$inforb[3].innerHTML="Series No: "+a.SeriesNumber;this.$inforb[4].innerHTML=this.series.SeriesDescription}}};PACS.View.prototype.setImage=function(a,c){if(!c.dataSet){this.image=c;this.imageData=null;this.draw();this.updateInfo();return true}if(this.image&&c){if(this.image.width!=c.width||this.image.height!=c.height){this.drawInfo=null}}this.image=c;var b=this.getImageDataCache(a);if(!b){b=new PACS.ImageData(c,this.context)}if(!this.wlInfo){this.wlInfo=b.resetWwc()}b.wwc=this.wlInfo;b.lut=this.lut;b.filter=this.filter;this.imageData=b;this.drawCanvas.width=c.width;this.drawCanvas.height=c.height;this.drawContext=this.drawCanvas.getContext("2d");this.redraw(true);this.updateInfo();return true};PACS.View.prototype.initDrawInfo=function(){if(this.isVrMode()){}this.drawInfo=createDrawInfo(this.image,this.canvas);this.resetDwTrans();this.updateDwWraper()};PACS.View.prototype.resetDwTrans=function(f,e,h,g){if(!this.drawInfo){return}this.drawInfo.transform={A:1,B:0,C:0,D:1,A1:1,B1:0,C1:0,D1:1}};PACS.View.prototype.addDwTrans=function(n,m,l,k){if(!this.drawInfo){return}var o=this.drawInfo.transform;var i=o.A*n+o.B*l;var h=o.A*m+o.B*k;var g=o.C*n+o.D*l;var e=o.C*m+o.D*k;o.A=i;o.B=h;o.C=g;o.D=e;var j=1/(i*e-h*g);o.A1=j*e;o.B1=-j*h;o.C1=-j*g;o.D1=j*i;if(this.doContext){this.doContext.update(this.drawInfo)}};PACS.View.prototype.memDraw=function(){if(this.isVrMode()){this.initDrawInfo();this.series.vr.draw(this.drawContext,this.wlInfo);return}if(this.isMprMode()){var a=this.series.getMprImgIdx();if(a<0||a>=this.series.images.length){clearContext(this.drawContext,this.drawCanvas.width,this.drawCanvas.height);return}}this.imageData.draw(this.drawContext,this.drawInfo)};PACS.View.prototype.vrDraw=function(){if(!this.vrInit){var a=this;this.vrInit=true;this.drawBgd();this.updateInfo();this.vr.initWebGl(this.$wraper[0],this.wlInfo,this.lut);this.vr.setClickCb(function(){a.setSelected(true)})}};PACS.View.prototype.redraw=function(a){if(this.isVrMode()){this.vrDraw();return}if(!this.imageData){return}if(a){this.imageData.initImageData()}if(!this.drawInfo){this.initDrawInfo()}this.memDraw();this.draw()};PACS.View.prototype.drawRuler=function(){var q=this.context;var n=this.image;var e;var b;var c=false;if(n.columnPixelSpacing&&n.rowPixelSpacing){e=n.columnPixelSpacing;b=n.rowPixelSpacing}else{e=1;b=1;c=true}var k=this.canvas.width;var s=this.canvas.height;var a=e*k/this.drawInfo.scale;var v=b*s/this.drawInfo.scale;if(s<400){v*=(s+100)/500}if(k<400){a*=(k+100)/500}var u=getProperSpan(Math.min(a*5/10,n.width*e*2));var t=getProperSpan(Math.min(v*5/10,n.height*b*2));if(!u||!t){return}q.lineCap="round";q.lineWidth=1;q.strokeStyle="#F00";q.font="Bold 16px Arial";q.fillStyle="#F00";q.beginPath();var o=10;var f=16;var d=10;var m=12;var l=10;var g=7;var p;var j=u*this.drawInfo.scale/e;q.moveTo(Math.round(k/2-j/2),s-o);q.lineTo(Math.round(k/2+j/2),s-o);if(!c){if(u<=50){d=20}}for(var r=0;r<=d;r++){q.moveTo(Math.round(k/2-j/2+(j/d*r)),s-o);if(r==0||r==d){p=m}else{if(r%5==0){p=l}else{p=g}}q.lineTo(Math.round(k/2-j/2+(j/d*r)),s-o-p)}if(u>10&&!c){q.fillText((u/10)+"cm",Math.round(k/2+j/2+f/2),s-o)}else{q.fillText((u)+(c?"pixel":"mm"),Math.round(k/2+j/2+f/2),s-o)}if(!c){if(t<=50){d=20}}j=t*this.drawInfo.scale/b;q.moveTo(o,Math.round(s/2-j/2));q.lineTo(o,Math.round(s/2+j/2));for(var r=0;r<=d;r++){if(r==0||r==d){p=m}else{if(r%5==0){p=l}else{p=g}}q.moveTo(o,Math.round(s/2-j/2+(j/d*r)));q.lineTo(o+p,Math.round(s/2-j/2+(j/d*r)))}if(t>10&&!c){q.fillText((t/10)+"cm",o,Math.round(s/2-j/2-f+5))}else{q.fillText((t)+(c?"pixel":"mm"),o,Math.round(s/2-j/2-f+5))}q.stroke()};PACS.View.prototype.drawCvtLine=function(c,e,b,d,f,a){var h=f(c,e);var g=f(b,d);a.moveTo(h[0],h[1]);a.lineTo(g[0],g[1])};PACS.View.prototype.drawMprLines=function(){var q=this.context;var d=this.image;var n=d.width;var f=d.height;var q=this.context;var k=this.series.mpr;var b=this.series.mprAxis;var g=this.doContext.convert;var l,i;q.lineCap="round";q.lineWidth=1;switch(k.getLastEvent()){case"cpi":case"cp":var e,c,a;if(b==AXIS_X){e="#F00";c="#0F0";a="#00F"}else{if(b==AXIS_Y){e="#F00";c="#00F";a="#0F0"}else{e="#0F0";c="#00F";a="#F00"}}q.strokeStyle=a;q.beginPath();var p=g(0,0);var o=g(n,0);var m=g(n,f);var j=g(0,f);q.moveTo(p[0],p[1]);q.lineTo(o[0],o[1]);q.lineTo(m[0],m[1]);q.lineTo(j[0],j[1]);q.lineTo(p[0],p[1]);q.stroke();var r=this.series.getImgPoint();q.strokeStyle=e;q.beginPath();this.drawCvtLine(0,r[1],n,r[1],g,q);q.stroke();q.strokeStyle=c;q.beginPath();this.drawCvtLine(r[0],0,r[0],f,g,q);q.stroke();break;case AXIS_X:switch(b){case AXIS_X:break;case AXIS_Y:case AXIS_Z:q.strokeStyle="#FF0";q.beginPath();this.drawCvtLine(0,0,0,f,g,q);this.drawCvtLine(n,0,n,f,g,q);q.stroke();l=k.getX();q.strokeStyle="#00F";q.beginPath();this.drawCvtLine(l,0,l,f,g,q);q.stroke();break}break;case AXIS_Y:switch(b){case AXIS_X:q.strokeStyle="#FF0";q.beginPath();this.drawCvtLine(0,0,0,f,g,q);this.drawCvtLine(n,0,n,f,g,q);q.stroke();l=k.getY();q.strokeStyle="#00F";q.beginPath();this.drawCvtLine(l,0,l,f,g,q);q.stroke();break;case AXIS_Z:q.strokeStyle="#FF0";q.beginPath();this.drawCvtLine(0,0,n,0,g,q);this.drawCvtLine(0,f,n,f,g,q);q.stroke();i=k.getY();q.strokeStyle="#00F";q.beginPath();this.drawCvtLine(0,i,n,i,g,q);q.stroke();break}break;case AXIS_Z:switch(b){case AXIS_X:case AXIS_Y:q.strokeStyle="#FF0";q.beginPath();this.drawCvtLine(0,0,n,0,g,q);this.drawCvtLine(0,f,n,f,g,q);q.stroke();i=k.getZ();q.strokeStyle="#00F";q.beginPath();this.drawCvtLine(0,i,n,i,g,q);q.stroke();break;case AXIS_Z:break}break}};PACS.View.prototype.drawObjs=function(){var b=this.drawInfo;var a=this.context;if(!this.doContext){this.doContext=new PACS.CtxWraper(a,b)}this.imageData.drawObjs(this.doContext)};PACS.View.prototype.draw=function(){var h=this.image;if(!h){this.drawBgd();return}if(!this.imageData){this.drawLoading();return}if(!this.drawInfo){this.initDrawInfo()}var f=this.drawInfo;var b=this.context;b.fillStyle="#000";b.fillRect(0,0,this.canvas.width,this.canvas.height);var a=this.drawCanvas.width;var e=this.drawCanvas.height;var c=this.drawCanvas.width*f.scale;var g=this.drawCanvas.height*f.scale;b.save();b.translate(f.ox+c/2,f.oy+g/2);var d=f.transform;b.transform(d.A1,d.C1,d.B1,d.D1,0,0);b.scale(f.scale,f.scale);b.drawImage(this.drawCanvas,-a/2,-e/2);b.restore();this.drawObjs(b,f);if(this.tools.showRuler&&!this.isVrMode()){this.drawRuler()}if(this.isMprMode()){this.drawMprLines()}};PACS.View.prototype.drawLoading=function(){var a=this.context;a.fillStyle="#000";a.fillRect(0,0,this.canvas.width,this.canvas.height);a.lineCap="round";a.lineWidth=1;a.strokeStyle="#FFF";a.font="Bold 25px Arial";a.fillStyle="#FFF";a.fillText("loading",this.canvas.width/2-50,this.canvas.height/2-12)};PACS.View.prototype.drawBgd=function(){var a=this.context;a.fillStyle="#000";a.fillRect(0,0,this.canvas.width,this.canvas.height)};PACS.View.prototype.updateDwWraper=function(){if(this.doContext&&this.drawInfo){this.doContext.update(this.drawInfo)}};PACS.View.prototype.setImageIdx=function(a){if(!this.series||!this.series.images||a<0||a>=this.series.images.length){return false}if(this.imageData&&undefined!=this.imageIndex){this.setImageDataCache(this.imageIndex,this.imageData)}this.imageIndex=a;this.setImage(a,this.series.images[a]);return true};PACS.View.prototype.getZoom=function(){if(!this.imageData){return"100"}if(!this.drawInfo){return"0"}return Math.floor(this.drawInfo.scale*100)};PACS.View.prototype.invert=function(){if(this.imageData){this.imageData.invert();this.redraw(false)}};PACS.View.prototype.rotate=function(h){if(this.imageData){this.drawInfo.rotate=(this.drawInfo.rotate+h+360)%360;h=h*Math.PI/180;var f=Math.round(Math.cos(h));var e=Math.round(Math.sin(h));var i=Math.round(-Math.sin(h));var g=Math.round(Math.cos(h));this.addDwTrans(f,e,i,g);this.redraw(false)}};PACS.View.prototype.setWwc=function(a){if(this.isVrMode()){if(this.vrInit){this.vr.setWwc(a)}return}if(!a){this.resetWwc();return}this.wlInfo={ww:a.ww,wc:a.wc};if(this.imageData){this.imageData.wwc=this.wlInfo;this.updateWLInfo();this.redraw(true)}};PACS.View.prototype.setLut=function(a){this.lut=a;if(this.isVrMode()){if(this.vrInit){this.vr.setLut(a)}return}if(this.imageData){this.imageData.lut=this.lut;this.redraw(true)}};PACS.View.prototype.setFilter=function(a){this.filter=a;if(this.imageData){this.imageData.filter=this.filter;this.redraw(true)}};PACS.View.prototype.flip=function(a){if(this.imageData){if(a){this.addDwTrans(-1,0,0,1)}else{this.addDwTrans(1,0,0,-1)}this.redraw(false)}};PACS.View.prototype.axescvt=function(b,g){var d=this.drawInfo;var b=(b-d.ox)/d.scale;var g=(g-d.oy)/d.scale;var c=d.transform;var a=d.sw/2;var f=d.sh/2;switch(d.rotate){case 0:break;case 90:break;case 180:break;case 270:break;default:break}var e=transXY(b-a,g-f,c.A1,c.B1,c.C1,c.D1);e[0]+=a;e[1]+=f;return e};PACS.View.prototype.resetDwinfo=function(){this.drawInfo=null;this.wlInfo=null;this.lut=null;this.filter=null};PACS.View.prototype.cancelDrawing=function(){var a=this.imageData;if(a){if(a.cancelDrawing()){this.redraw(false)}}};PACS.View.prototype.reset=function(b){if(!this.image||!this.drawInfo){return}var c=this.imageData;this.updateDwWraper();switch(b){case ResetTool.ALL:this.resetDwinfo();this.initDrawInfo();if(this.imageData){if(0){this.series.mpr.destroy()}else{this.wlInfo=this.imageData.resetWwc();this.imageData.reset();this.redraw(true)}}return;case ResetTool.ORIGINAL_SIZE:this.drawInfo.scale=1;centerDrawInfo(this.drawInfo,this.canvas.width,this.canvas.height,this.image.width,this.image.height);break;case ResetTool.AUTO_SIZE:this.initDrawInfo();break;case ResetTool.CT_WL:this.resetWwc();break;case ResetTool.LUT:this.lut=null;break;case ResetTool.FILTER:this.filter=null;break;case ResetTool.MARK_TEST:if(c){c.drawObjects=[];c.lastDrawObject=null}break;case ResetTool.ROTATE:this.resetDwTrans();if(c){c.inverse=false}break;case ResetTool.MPR:if(this.isMprMode()){this.series.mpr.destroy()}return;case ResetTool.VR:if(this.isVrMode()){this.vr.destroy();delete this.vr;this.vr=null;this.vrInit=false;var a=this.series;this.setSeries(null);this.setSeries(a)}break;default:break}if(!c){return}c.wwc=this.wlInfo;c.lut=this.lut;c.filter=this.filter;this.redraw(true)};PACS.View.prototype.resetWwc=function(){if(this.imageData){this.wlInfo=this.imageData.resetWwc();this.updateWLInfo();this.redraw(true)}};PACS.View.prototype.zoomIn=function(d){var c=this.drawInfo.scale;this.drawInfo.scale*=d;if(this.drawInfo.scale<0.2&&this.drawInfo.scale*this.imageData.imageData.height<this.canvas.height/20){this.drawInfo.scale=this.canvas.height/20/this.imageData.imageData.height}else{if(this.drawInfo.scale>5&&this.drawInfo.scale*this.imageData.imageData.height>this.canvas.height*20){this.drawInfo.scale=this.canvas.height*20/this.imageData.imageData.height}}var b=(this.drawInfo.scale-c)*this.imageData.imageData.width;var a=(this.drawInfo.scale-c)*this.imageData.imageData.height;this.drawInfo.ox-=b/2;this.drawInfo.oy-=a/2;this.updateDwWraper()};PACS.View.prototype.onMprEvent=function(c,f,e,d){switch(c){case"cpi":this.initDrawInfo();this.zoomIn(0.7);case"cp":if(this.series.mprAxis==AXIS_X){this.changeImage(f-this.imageIndex,true,true)}else{if(this.series.mprAxis==AXIS_Y){this.changeImage(e-this.imageIndex,true,true)}else{if(this.series.mprAxis==AXIS_Z){this.changeImage(d-this.imageIndex,true,true)}}}break;case AXIS_X:case AXIS_Y:case AXIS_Z:if(this.series.mprAxis==c){this.changeImage(f-this.imageIndex,true)}else{this.draw()}break;case"de":var b=this.series;var a=b.mpr;this.setSeries(null);if(b==a.seriesZ){this.setSeries(b)}break;default:break}};PACS.View.prototype.startVR=function(a){if(!a){if(this.VR){delete this.VR;this.VR=null;this.redraw(false)}return}if(this.VR){return}this.VR=PACS.VR(this.series);this.redraw(false)};PACS.View.prototype.getTools=function(a){if(this.VR){return ActionTool.VR}return this.tools.tool};PACS.View.prototype.getImageModality=function(){if(this.image){this.image.Modality}return""};PACS.View.prototype.isCTImage=function(){return(this.getImageModality()==="CT")};PACS.View.prototype.playImage=function(a){if(a){if(!this.imagePlayer){this.imagePlayer=new PACS.ImagePlayer(this)}if(this.imagePlayer.playing){return}this.imagePlayer.play()}else{if(this.imagePlayer){this.imagePlayer.stop()}else{return}}if(this.listeners.onPlaying){this.listeners.onPlaying(a)}};PACS.View.prototype.isPlayingImage=function(){return this.imagePlayer&&this.imagePlayer.playing};PACS.View.prototype.getImagePlayer=function(){return this.imagePlayer};PACS.View.prototype.next=function(){if(!this.series||!this.series.images){return}var a=this.imageIndex+1;a%=this.series.images.length;this.changeImage(1,false)};