PACS.Image=function(){};PACS.Image.DefaultWwc=function(){var a={wc:40,ww:400};return a};PACS.Image.prototype.init=function(){if(!this instanceof PACS.Image){d("PACS.Image init")}if(!this.detail){this.wwc=PACS.Image.DefaultWwc();return}this.width=this.detail.Columns;this.height=this.detail.Rows;this.data=new Int16Array(this.data);var a=this.detail.WindowCenter;var b=this.detail.WindowWidth;if(undefined==a||undefined==b){this.wwc=PACS.Image.DefaultWwc()}else{this.wwc={wc:a,ww:b}}};PACS.Image.prototype.mprInit=function(){if(!this instanceof PACS.Image){d("PACS.Image init")}var a=this.detail.WindowCenter;var b=this.detail.WindowWidth;if(undefined==a||undefined==b){this.wwc=PACS.Image.DefaultWwc()}else{this.wwc={wc:a,ww:b}}};PACS.Image.prototype.__init=function(){if(this.inited){return}var j=this.width;var e=this.height;var l=j*e;var g=0;var a=0;var f=0;var k;var c=this.data;if(!c){return}for(var b=0;b<l;b++){k=c[b];if(k==63488){continue}f+=k;if(k<a){a=k}if(k>g){g=k}}this.minVar=a;this.maxVar=g;this.totalVar=f;this.inited=true};PACS.Image.prototype.getImageData=function(b,f,y){var g=this.width;var q=this.height;var x=this.data;var l=g*q;var r=b.createImageData(g,q);var p=r.data;if(undefined==f||undefined==y){var c=this.getWwc();f=c.wc;y=c.ww}var u=255;var m=this.detail.PhotometricInterpretation==="MONOCHROME2"?1:-1;var t=m*u/y;var s=u*(0.5-m*f/y);var a;var e=this.detail.RescaleSlope;var k=this.detail.RescaleIntercept;if(undefined!=e&&undefined!=k){t=t*e;s=t*k+s}for(var o=0,n=0;o<l;o++,n+=4){v=x[o];v=t*v+s;p[n]=v;p[n+1]=v;p[n+2]=v;p[n+3]=255}return r};PACS.Image.prototype.getValue=function(a,f){var e=this.data;if(!e){return"N/A"}var b=this.width;var c=f*b+a;if(c<0||c>=e.length){return"N/A"}return e[c]};PACS.Image.prototype.drawThumb=function(i){initCanvas(i);var e=i.getContext("2d");var a=this.getImageData(e);if(!a){return}var m=this.width;var k=this.height;var j=i.width;var b=i.height;var o=getScale(m,k,j,b);var g=parseInt(o*m);var l=parseInt(o*k);var f,c;f=(j-g)/2;c=(b-l)/2;var n=getTempCanvas();n.width=m;n.height=k;n.getContext("2d").putImageData(a,0,0);e.save();e.translate(f,c);e.scale(o,o);e.drawImage(n,0,0);e.restore()};PACS.Image.prototype.copyBasic=function(c){this.PatientName=c.PatientName;this.PatientBirthDate=c.PatientBirthDate;this.PatientID=c.PatientID;this.PatientSex=c.PatientSex;this.StudyInstanceUID=c.StudyInstanceUID;this.InstanceNumber=c.InstanceNumber;this.Modality=c.Modality;this.height=c.height;this.width=c.width;var a=c.detail;var b={};b.AcquisitionDate=a.AcquisitionDate;b.AcquisitionTime=a.AcquisitionTime;b.ContrastBolusAgent=a.ContrastBolusAgent;b.SliceThickness=a.SliceThickness;b.SliceLocation=a.SliceLocation;b.PhotometricInterpretation=a.PhotometricInterpretation;b.Columns=a.Columns;b.Rows=a.Rows;b.WindowCenter=a.WindowCenter;b.WindowWidth=a.WindowWidth;b.RescaleSlope=a.RescaleSlope;b.RescaleIntercept=a.RescaleIntercept;b.PixelSpacing=[0,0];b.PixelSpacing[0]=a.PixelSpacing[0];b.PixelSpacing[1]=a.PixelSpacing[1];this.detail=b};PACS.Image.prototype.getGrayData=function(b,c,n,o){var f=this.width;var t=this.height;var A=this.data;var m=f*t;var z=255;var p=this.detail.PhotometricInterpretation==="MONOCHROME2"?1:-1;var x=p*z/b.ww;var u=z*(0.5-p*b.wc/b.ww);var a;var g;var e=this.detail.RescaleSlope;var l=this.detail.RescaleIntercept;if(undefined!=e&&undefined!=l){x=x*e;u=x*l+u}var s,r,q;var y;for(s=0,q=0;s<t;s++){y=n+s*o;for(r=0;r<f;r++,q++){g=A[q];g=x*g+u;if(g<2){g=0}else{if(g>=255){g=255}else{}}c[y+r]=g}}return c};PACS.Image.prototype.getGrayData0=function(f,n,o,b){var r=this.width;var m=this.height;var l=this.data;var t=r*m;var j=255;var e=this.detail.PhotometricInterpretation==="MONOCHROME2"?1:-1;var c=e*j/f.ww;var a=j*(0.5-e*f.wc/f.ww);var p;var s;var g=this.detail.RescaleSlope;var q=this.detail.RescaleIntercept;if(undefined!=g&&undefined!=q){c=c*g;a=c*q+a}for(var k=0;k<t;k++){s=l[k];s=c*s+a;if(s<10){s=0}else{n[o+k]=s}}return n};PACS.Image.prototype.getWwc=function(a){var b=PACS.Image.DefaultWwc();if(this.wwc.wc.length>0){b.wc=this.wwc.wc[0]}else{b.wc=this.wwc.wc}if(this.wwc.ww.length>0){b.ww=this.wwc.ww[0]}else{b.ww=this.wwc.ww}return b};function extendPacsImage(b){var a=new PACS.Image();$.extend(b,a);b.init();return a}PACS.ImageData=function(b,a){if(!(this instanceof PACS.ImageData)){return new PACS.ImageData(b,a)}this.image=b;this.inverse=false;this.context=a;this.photometric=b.detail.PhotometricInterpretation;this.drawObjects=[];this.lastDrawObject=null;this.resetWwc()};PACS.ImageData.prototype.resetWwc=function(){var a=this.image.getWwc();return this.wwc=a};PACS.ImageData.prototype.reset=function(){this.resetWwc();this.drawObjects=[];this.lastDrawObject=null;this.lut=null;this.filter=null;this.inverse=false};PACS.ImageData.prototype.clearData=function(){if(this.imageData){ImageDataCache.put(this.imageData);this.imageData=null}};PACS.ImageData.prototype.invert=function(){if(!this.imageData){return}var g=this.imageData.data;var a=this.imageData.width;var f=this.imageData.height;var e=a*f*4;var b;for(var c=0;c<e;c+=4){b=g[c];b=255-b;g[c]=255-g[c];g[c+1]=255-g[c+1];g[c+2]=255-g[c+2]}this.inverse=!this.inverse};PACS.ImageData.prototype.initImageData=function(){var n=this.image;var g=n.width;var t=n.height;if(!this.imageData){this.imageData=ImageDataCache.getex(this.context,g,t)}var z=n.data;var m=g*t;var s=this.imageData.data;var y=255;var o=this.photometric==="MONOCHROME2"?1:-1;var x=o*y/this.wwc.ww;var u=y*(0.5-o*this.wwc.wc/this.wwc.ww);var b;var k;var c=this.inverse;var f=n.detail.RescaleSlope;var l=n.detail.RescaleIntercept;if(undefined!=f&&undefined!=l){x=x*f;u=x*l+u}if(this.filter){var q=Uint8ClampedArrayCache.get(m,0);for(var r=0;r<m;r++){k=z[r];k=x*k+u;q[r]=k}z=this.filter.process(q,g,t);Uint8ClampedArrayCache.put(q);var b=this.lut;if(b){var e=b.bytes;var a;for(var r=0,p=0;r<m;r++,p+=4){k=z[r];if(c){k=255-k}a=e[k];s[p]=a[0];s[p+1]=a[1];s[p+2]=a[2];s[p+3]=255}}else{for(var r=0,p=0;r<m;r++,p+=4){k=z[r];if(c){k=255-k}s[p]=k;s[p+1]=k;s[p+2]=k;s[p+3]=255}}Uint8ClampedArrayCache.put(z)}else{var b=this.lut;if(b){var e=b.bytes;var a;for(var r=0,p=0;r<m;r++,p+=4){k=z[r];k=x*k+u;if(k<0){k=0}else{if(k>255){k=255}else{k=parseInt(k)}}if(c){k=255-k}a=e[k];s[p]=a[0];s[p+1]=a[1];s[p+2]=a[2];s[p+3]=255}}else{for(var r=0,p=0;r<m;r++,p+=4){k=z[r];k=x*k+u;if(k<0){k=0}else{if(k>255){k=255}else{k=parseInt(k)}}if(c){k=255-k}s[p]=k;s[p+1]=k;s[p+2]=k;s[p+3]=255}}}};PACS.ImageData.prototype.mousecaptrued=function(){var a=this.lastDrawObject;return(a&&!a.done)};PACS.ImageData.prototype.mousedown=function(c,a,f){var e=this.lastDrawObject;this.lastX=a;this.lastY=f;if(e&&!e.done){e.mousedown(c,a,f)}else{var b=new PACS.DrawObject(this,c,a,f);if(b.isValid()){this.drawObjects[this.drawObjects.length]=b;this.lastDrawObject=b}}return true};PACS.ImageData.prototype.mousemove=function(a,c){var b=this.lastDrawObject;this.lastX=a;this.lastY=c;if(b&&!b.done){b.mousemove(a,c);return true}return false};PACS.ImageData.prototype.mouseup=function(a,c){var b=this.lastDrawObject;if(b&&!b.done){if(undefined==a){a=this.lastX;c=this.lastY}b.mouseup(a,c);if(b.done){this.lastDrawObject=null}return true}return false};PACS.ImageData.prototype.cancelDrawing=function(){var a=this.lastDrawObject;if(a&&!a.done){this.lastDrawObject=null;this.drawObjects.length=this.drawObjects.length-1;return true}return false};PACS.ImageData.prototype.draw=function(a,e){a.putImageData(this.imageData,0,0);var f=this.drawObjects;var c=f.length;if(c){a.lineCap="round";a.lineJoin="round";a.lineWidth=1;a.strokeStyle="#F00";a.font="Bold 16px Arial";a.fillStyle="#F00";a.beginPath();for(var b=0;b<c;b++){if(f[b]){f[b].draw(a)}}a.stroke();for(var b=0;b<c;b++){if(f[b]){f[b].drawText(a,e)}}}};