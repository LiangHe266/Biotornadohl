var times=0;PACS.VR=function(e,b){if(!this instanceof PACS.VR){return new PACS.VR(e)}if(!Detector.webgl){return}if(!e){return}var a=e.images;if(!a||!a.length){return}var c=a[0].width;var f=a[0].height;var g=a.length;if(c!=512||f!=512){return}if(g<10){return}if(g>256){g=256}this.xSize=c;this.ySize=f;this.zSize=g;this.series=e;this.images=a;this.inited=true;this.steps=256};PACS.VR.AlphaTbl=[{stop:0,value:0},{stop:254,value:255},{stop:255,value:255}];PACS.VR.AlphaTbl1=[{stop:0,value:255},{stop:1,value:255},{stop:255,value:255}];PACS.VR.prototype.createTransTex0=function(){var e=document.createElement("canvas");e.height=16;e.width=256;var c=e.getContext("2d");var b=c.createLinearGradient(0,0,e.width-1,e.height-1);b.addColorStop(0.1,"#00FA58");b.addColorStop(0.7,"#CC6600");b.addColorStop(1,"#F2F200");c.fillStyle=b;c.fillRect(0,0,e.width-1,e.height-1);var a=new THREE.Texture(e);a.wrapS=a.wrapT=THREE.ClampToEdgeWrapping;a.needsUpdate=true;return a};PACS.VR.prototype.createTransTex=function(p){var c,m,q,s;var l,h,o,k;var t=p.bytes;var f=new Uint8Array(256*16*4);var n=PACS.VR.AlphaTbl;for(var l=0;l<256;l++){c=t[l][0];m=t[l][1];q=t[l][2];k=(c+m+q)/3;s=getLinearValue(n,k);s=Math.round(s);d("i:"+l+"  r:"+c+" g:"+m+" b:"+q+" a:"+s);for(h=0;h<16;h++){o=h*256*4+l*4;f[o+0]=c;f[o+1]=m;f[o+2]=q;f[o+3]=s}}var e=new THREE.DataTexture(f,256,16,THREE.RGBAFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.NearestFilter,THREE.NearestFilter);e.wrapS=e.wrapT=THREE.ClampToEdgeWrapping;e.needsUpdate=true;return e};PACS.VR.prototype.createTransTex2=function(p){var c,m,q,s;var l,h,o,k;var u=p.bytes;var f=new Uint8Array(16*16*4);var n=PACS.VR.AlphaTbl;for(var l=0;l<16;l++){var t=l*10+100;if(t>255){t=255}c=t;m=t;q=t;s=255;d("i:"+l+"  r:"+c+" g:"+m+" b:"+q+" a:"+s);for(h=0;h<16;h++){o=h*16*4+l*4;f[o+0]=c;f[o+1]=m;f[o+2]=q;f[o+3]=s}}var e=new THREE.DataTexture(f,16,16,THREE.RGBAFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.NearestFilter,THREE.NearestFilter);e.wrapS=e.wrapT=THREE.ClampToEdgeWrapping;e.needsUpdate=true;return e};PACS.VR.prototype.createTransTex3=function(p){var c,m,q,s;var l,h,o,k;var u=p.bytes;var f=new Uint8Array(16*16);var n=PACS.VR.AlphaTbl;for(var l=0;l<16;l++){var t=l*10+100;if(t>255){t=255}if(l<5){t=0}else{t=255}c=t;m=t;q=t;s=255;d("i:"+l+"  r:"+c+" g:"+m+" b:"+q+" a:"+s);for(h=0;h<16;h++){o=h*16+l;f[o+0]=c}}var e=new THREE.DataTexture(f,16,16,THREE.AlphaFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.NearestFilter,THREE.NearestFilter);e.wrapS=e.wrapT=THREE.ClampToEdgeWrapping;e.needsUpdate=true;return e};PACS.VR.prototype.initData=function(c){var l=this.series.images;var n=this.xSize;var m=this.ySize;var k=this.zSize;var p=n*m*k;var h;var f;var j=0;if(!this.data){h=new Uint8Array(n*m*256)}else{h=this.data}if(!c){c={ww:400,wc:40}}var a=n*16;var o=(m-1)*16*n;var e=0;if(k<256){e=parseInt((256-k)/2);j=parseInt(e/16)*16*n*m;j+=(e%16)*n}var b=new Date().getTime();for(var g=0;g<=k;g++){if(k==g){f=l[k-1]}else{f=l[g]}if(null==f){d("image is NULL")}f.getGrayData(c,h,j,a);j+=n;e++;if(e%16==0){j+=o}}this.data=h;console.log("init data takes "+(new Date().getTime()-b)+"ms")};PACS.VR.prototype.initData0=function(b){var j=this.series.images;var l=this.xSize;var k=this.ySize;var h=this.zSize;var m=l*k*h;var f;var c;var g=0;if(!this.data){f=new Uint8Array(l*k*256)}else{f=this.data}if(!b){b={ww:400,wc:40}}if(h<256){g+=(256-h)/2*l*k}var a=new Date().getTime();for(var e=0;e<h;e++,g+=l*k){c=j[e];c.getGrayData(b,f,g)}this.data=f;console.log("init data takes "+(new Date().getTime()-a)+"ms")};PACS.VR.prototype.initWebGl=function(l,e,a){var l;var z,E,t;var D;var C=[];var g;var q;var u=$(l);var r=u.width()-8;var o=u.height()-8;var k=this.xSize;var j=this.ySize;var F;if(1){this.initData(e);F=this.data}else{var n=k*j*256;F=new Uint8Array(n);var v;for(var v=0;v<n;v++){F[v]=255}}var h=new THREE.DataTexture(F,k*16,j*16,THREE.AlphaFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.NearestFilter,THREE.NearestFilter);h.needsUpdate=true;h.generateMipmaps=false;if(!a){a=PACS.CreateDefaultLut()}var c=this.createTransTex(a);var p=new THREE.Vector2(r,o);var B=new THREE.WebGLRenderTarget(p.x,p.y,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,format:THREE.RGBFormat,type:THREE.FloatType,generateMipmaps:false});var f=new THREE.ShaderMaterial({vertexShader:document.getElementById("vertexShaderFirstPass").textContent,fragmentShader:document.getElementById("fragmentShaderFirstPass").textContent,side:THREE.BackSide});q=new THREE.ShaderMaterial({vertexShader:document.getElementById("vertexShaderSecondPass").textContent,fragmentShader:document.getElementById("fragmentShaderSecondPass").textContent,side:THREE.FrontSide,uniforms:{tex:{type:"t",value:B},cubeTex:{type:"t",value:h},transferTex:{type:"t",value:c},steps0:{type:"1f",value:768},alphaCorrection0:{type:"1f",value:0.2},stacks:{type:"1f",value:16},layers:{type:"1f",value:256},temp:{type:"1f",value:1}}});z=new THREE.Scene();E=new THREE.Scene();var A=new THREE.BoxGeometry(1,1,1);A.doubleSided=true;var G=new THREE.Mesh(A,f);var b=new THREE.Mesh(A,q);z.add(G);E.add(b);t=new THREE.WebGLRenderer();t.domElement.className="vrcanvas";l.appendChild(t.domElement);var w=new THREE.PerspectiveCamera(40,r/o,0.01,10000000);w.position.z=3;var m=new THREE.TrackballControls(w,t.domElement);m.target.set(0,0,0);m.rotateSpeed=10;m.zoomSpeed=1.2;m.panSpeed=0.8;m.noZoom=false;m.noPan=true;m.staticMoving=true;m.dynamicDampingFactor=0.15;m.keys=[65,83,68];this.stop=false;this.camera=w;this.renderer=t;this.controls=m;this.sceneFirstPass=z;this.sceneSecondPass=E;this.materialFirstPass=f;this.materialSecondPass=q;this.meshFirstPass=G;this.meshSecondPass=b;this.boxGeometry=A;this.rtTexture=B;this.cubeTex=h;this.transTex=c;this.container=l;this._setSize(r,o);this.animate()};PACS.VR.prototype.render=function(){this.renderer.render(this.sceneFirstPass,this.camera,this.rtTexture,true);this.renderer.render(this.sceneSecondPass,this.camera)};PACS.VR.prototype.animate=function(){var b=this;var c=function(){if(!b.stop){b.animate()}};var a=function(){requestAnimationFrame(c)};this.controls.update();this.render();setTimeout(a,100)};PACS.VR.prototype._setSize=function(a,b){this.camera.aspect=a/b;this.camera.updateProjectionMatrix();this.renderer.setSize(a,b)};PACS.VR.prototype.setSize=function(a,b){this._setSize(a+2,b+2)};PACS.VR.prototype.setLut=function(b){var a=this.createTransTex(b);if(this.transTex){this.transTex.dispose()}this.materialSecondPass.uniforms.transferTex.value=a;this.transTex=a};PACS.VR.prototype.setWwc=function(a){this.initData(a);this.cubeTex.needsUpdate=true};PACS.VR.prototype._destroy=function(){this.container.removeChild(this.renderer.domElement);this.controls.dispose();this.cubeTex.dispose();this.rtTexture.dispose();this.materialSecondPass.dispose();this.materialFirstPass.dispose();this.boxGeometry.dispose();this.transTex.dispose();delete this.camera;delete this.sceneFirstPass;delete this.sceneSecondPass;delete this.meshFirstPass;delete this.meshSecondPass;delete this.renderer;this.controls.mousedownCb=null;this.camera=null;this.renderer=null;this.controls=null;this.sceneFirstPass=null;this.sceneSecondPass=null;this.materialSecondPass=null;this.rtTexture=null;this.cubeTex=null;this.transTex=null;this.materialFirstPass=null;this.meshFirstPass=null;this.meshSecondPass=null;this.boxGeometry=null};PACS.VR.prototype.destroy=function(){this.stop=true;var a=this;setTimeout(function(){a._destroy()},200)};PACS.VR.prototype.setClickCb=function(a){this.controls.mousedownCb=a};